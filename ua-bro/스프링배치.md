### 목차
- 배치 애플리케이션이란?
- 배치와 스케쥴러의 차이
- 배치의 도메인 용어
- 스프링 배치 활용하기
- 배치 어플리케이션 운영하기



- 배치 어플리케이션
    - 개발자가 정의한 작업을 한번에 일괄처리하는 애플리케이션
    - 배치를 적용한 애플리케이션
        - 매출 데이터를 이용한 일 매출 집계
        - 매우 큰 데이터를 활용한 보험 급여 결정
        - 트랜잭션 방식으로 포맷, 유효성 확인 및 처리가 필요한 내무 및
        외부 시스템에서 수신한 정보를 기록 시스템으로 통합
    - 대용량의 기반데이터를 활용한 크롤링
        - 사용자의 접속이 거의 없는 시간대에 주기적으로 시도한다.
    - 정해진 시간에 구독을 신청한 회원에게 일괄 전송
    - 다른 정보를 열람하는 등 다른 서비스에 영향을 주지 않는다.
    - 배치 어플리케이션이 필요한 상황
        - 일정 주기로 실행해야 할때
        - 실시간 처리가 어려운 대량의 데이터를 처리해야 할 때
            - 이런 작업을 하나의 애플리케이션에 수행하면 성능 저하를 유발할 수 있으니
            배치 어플리케이션을 구현한다.
 
- 배치 어플리케이션의 조건
    - 대용량 데이터 - 배치 어플리케이션은 대량의 데이터를 가져오거나, 전달하거나 계산하는 등의 처리를 할 수 있어야 한다.
    - 자동화 - 배치 어플리케이션은 심각한 문제해결을 제외하고는 사용자의 개입없이 실행되어야 한다.
    - 견고성 - 배치 어플리케이션은 잘못된 데이터를 충돌/ 중단 없이 처리할 수 있어야 한다.
    - 신뢰성 - 배치 어플리케이션은 무엇이 잘못 되었는지를 추적할 수 있어야 합니다(로깅 , 알림)
    - 성능 - 배치 어플리케이션은 지정한 시간 안에 처리를 완료하거나 동시에 실행되는 다른 어플리케이션을 방해하지
    않도록 수행되어야 합니다.

- 배치와 스케쥴러의 차이
    - Spring Batch
    - Auartz
    
- 스케쥴링이란?
    - 매 시간 지정한 시간에 지정한 동작을 수행하는 것!
- 배치 어플리케이션의 절대적인 목적은 대용량 데이터 처리이다.
- 배치 프레임워크에서 스케쥴링 기능을 제공하지 않는다.
- 스케쥴링 프레임워크는 배치를 도와주는 보완제 역할이다.

- 배치의 도메인 용어
    - JobRepository
    - Job
    - JobLauncher
    - Step
        - ItemReader
        - ItemProcessor
        - ItemWriter
        
- Job   1
    - Job이름을 정의
    - Step을 정의하고 순서를 정의
    - Job의 재사용 가능성을 정의
- JobInstance * 1
    - 논리적으로 Job을 실행
    - JobParameters를 이용하여 구분
    - JobInstance = Job + identifying JobParameters
- Job Execution *
    - Job을 실행하는 단일 시도
    - 실패했던 JobInstance에 대해 새로운 실행을 하면
    새로운 JobExecution이 생성
 
실행할 날짜가 잡 파라미터가 된다. 잡인스턴스들이 실행한 결과들이 잡익스큐션이 나온다.
 
-JobExecution Properties
    - BatchStatus : 실행 상태를 나타낸다 실행중이면 started 실패하면 failed
    성공하면 completed
    - ExitStatus : 실행결과를 나타낸다. ExitCode를 포함한다.
- step
    - 잡은 하나이상의 스텝으로 구성되어야 된다.
    - 배치 작업의 독립적이고 순차적인 단계를 캡슐화 하는 도메인 객체
    - 모든 잡은 하나 또는 그 이상의 step으로 구성된다.
    - step의 내용은 개발자의 재량이므로 복잡하거나 단순하게 구현 가능하다.
- StepExecution
    - status: 실행 상태를 나타낸다
    - ExitStatus: 실행의 결과를 나타낸다.
    - ReadCount , WriteCount, CommitCount, RollbackCount, FilterCount등 실행에 대한 다양한 정보를 담고있다.
    어떤 데이터를 어떻게 처리했나의 정보를 담고 있다.
- JobRepository: Job,Step 구현을 위한 CRUD 작업을 제공한다.
    - 아까 봤던 잡 익스큐션 스텝익스큐션 데이터베이스에 저장하고 불러오는 작업을 한다.
- JobLauncher : Job을 시작학기 위한 간단한 인터페이스, 구현시 JobRepository에서 유효한 JobExecution을 획득하고 Job을 실행한다.
    - 프레임워크를 이용하는 제공받는 작업자가 받는다.
    - Spring Batch 사용시 제공받는다.
    - 메타데이터를 제공 받기에 비즈니스 로직에 집중을 하면 된다.
- Item: 작업에 사용하는 데이터
    - 배치에서 정의한 작업이 데이터베이스를 이용하면 한 로우가 아이템이라고 생각하면 된다.
- ItemReader : Step에서 한 항목씩 검색한다. 모든 항목이 소진된 경우 null을 반환한다.
    - 스텝에서 아이템 하나씩 읽어오는 기능을 하는 객체이다.
- ItemWriter : 여러 출력항목을 나타낸다.
    - 가져온 아이템을 가지고서 출력항목을 나타낸다.
    - 데이터베이스에 저장하는 일을 담당한다.
- ItemProcessor : 비즈니스 처리를 담당한다. 항목이 유효하지 않다고 판단되는 경우 null을 반환한다.
    - 자바에서 프레임워크에서 Optional로 감싸는 비용을 줄여도 된다.

- 스프링 배치활용할 경우
    - 잡런처 잡레포지토리는 구현하지 않는다.

- 스프링 배치를 이용하게 되면 chunk-oriented Processing
    - 청크 단위로 진행
    - 각 커밋 사이에 처리될 row(item)의 수
    - 성공시 chunk 만큼 커밋
    - 실패시 chunk 만큼 롤백
- ItemReader
    - Cursor와 Paging 기능을 제공한다.
    - Cursor
        - 데이터베이스와 커넥션을 유지한채 계속 데이터를 뽑아옴
    - Paging
        - 페이지 사이즈만큼 데이터를 가져옴
    - Paging과 관련된 걸 많이쓴다.
        - 메모리에 page사이즈만큼 가져온다
        - chunk size== page size를 권장한다.     
        - chunk를 하나의 트랜잭션에서 처리
            - JPA의 영속성 컨텍스트 사용가능
        - chunk size > page size일때의 문제점:
        하나의 트랜잭션 처리를 위해 여러번의 조회를 해야한다.
- ItemWriter
    - chunk단위만큼 한번에 작업 수행
    - chunk 단위만큼의 list를 다룬다.
- ItemProcessor(Optional)
    - Chunk-oriented Tasklet을 구성할때 선택 요소다.
    - 데이터를 가공/ 필터링 하는 역할을 한다.
        - Writer에서도 구현 가능한 역할 -> 비즈니스 코드가 섞이는 것을 방지한다.
    - Step에 여러 로직이 필요할 때 도입을 고려해 유지보수성을 증가시킨다.
    - 데이터 처리를 실패했을 때 null을 반환해 writer에 전달되지 않는다.
- 하나의 잡에서 여러가지 스텝을 정의했을때 순차적으로 작업을 정의할수 있다.
- 조건 분기문을 이용해서 결과에 따라서 작업을 정의를 할수 있다.
- BatchStatus가 아닌 ExitStatus로 판단한다. -> 실행 상태가 아닌 실행 결과이다.

- 배치 어플리케이션 운영하기
    - 테스트 코드를 반드시 작성한다!
        - QA를 하기 어렵기 때문에 테스트 코드가 필요하다.
        - 대용량 데이터 셋업 대기하고 기대하기까지 오래걸린다.
        - 복잡한 쿼리를 실행한 결과를 처리하고 다시 데이터베이스에 저장하는 작업이기 때문에
        통합 테스트를 실행한다.
        - Item R W , 들을 각각 테스트 코드를 작성한다.
        - 보통 단위 테스트를 이용해서 내부 작업을 검사하고 전체 테스트 코드를 반드시 작성한다.  

- 관리도구
    - Cron(리눅스 작업 스케쥴러)
    - Spring Mvc + API Call(권장하지 않는 방법)
    - Spring Batch Admin (Deprecated)
    - Quartz + Admin ( 스케쥴러 프레임워크 + 관리자 페이지 구현 )
    - CI Tool(Jenkins)
        - 장점
            -Integration(Slack Email등)
            - 실행 이력/ 로그관리
            - 다양한 실행방법(Rest API / 스케쥴링 / 수동실행)
            - 파이프라인
    - 젠킨스의 장점 - 공통 설정 관리
         - Global Properties를 설정
    
        - 파이프라인
        - Job 내부에 Step을 여러개 설계하는것보다 권장된다.
        - Job을 단독으로 실행할수 있도록 설계하는 것이 유지보수에 더 좋다.
- Chunk 최적화
    - 구체적인 가이드가 존재하지 않는다.
    - 설계한 비지니스 로직에 대해서 가장 효율적인 단위를 설정해야 한다.
    - 여러개의 배치 작업을 구성하는 경우 다른 배치 작업에 영향을 주면 안된다.
    - 스프링 배치에서는 chunk사이즈 만큼 메모리에 데이터를 적재해야 하기 때문에 다른 배치에서 사용할 수 있는 메모리가 줄어들 수 있다.

- 요약
    - 배치 어플리케이션의 절대적인 목적은 대용량 데이터 처리이다.
    - 배치와 스케쥴링 차이를 이해한다.
        - 스케쥴링은 배치의 보완제 역할
    - 배치 어플리케이션의 기본 구성은 JobLauncher , Job ,Step으로 구성한다.
        - 스프링 배치와 같은 프레임워크를 이용해서 비즈니스 로직에 집중할 수 있다.
    - 다양한 방법으로 배치 애플리케이션을 운영할수 있다.
        - 설계한 비즈니스 로직에 맞춰서 선택하자
