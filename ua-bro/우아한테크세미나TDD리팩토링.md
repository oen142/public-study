## TDD리팩토링

#### 의식적인 연습이란?

- TDD와 리팩토링이 중요한지는 안다 연습한다. 연습을 많이 한다고 잘하지는 않는다.
- 무의식적으로 하기 때문에 노하우가 늘지 않는다.
- TDD리팩토링 5,6년을 도전한후에야
- 테스트하기 쉬운 코드와 테스트하기 어려운 코드를 보는 눈
- 테스트 하기 어려운 코드를 테스트 하기 쉬운 코드로 설계하는감

- 멋져보인다. 하지만 생각만큼 쉽게 연습할 수 있는 녀석이 아니다.
- 좀더 효과적으로 연습할 수 있는 방법은 없을까?

- 아마추어와 프로의 결저적 차이
    - 목적의식이 있는 연습에 얼마나 많은 시간을 투자했느냐
    
- 의식적인 연습의 7가지 원칙
    - 효과적인 기번ㅂ이 수립되어 있는 기술 연마
    - 개인 컴포트존을 벗어난 지점에서 진행 자신의 현재능력을 살짝 넘어가는 작업을 지속적으로 시도
    - 명확하고 구체적인 목표를 가지고 진행
    - 신중하고 계획적이다 개인이 온전히 집중하고 의식적으로 행동할 것을 요구
    - 피드백과 피드백에 따른 행동 변경을 수반
    - 효과적인 심적 표상을 만들어내는 한편으로 심적 표상에 의존
    - 기존에 습득한 기술의 특정 부분을 집중적으로 개선함으로써 발전 시키고, 수정하는 과정을 수반


- 의식적인 연습으로 효과적으로 연습하자

- 의식적인 연습 예시 - 우테코 프리코스

- 3주동안 진행 매주 해결해야할 미션을 부여
- 미션을 완료한 후 깃헙의 PR로 제출
- 각 PR평가후 공통 피드백


- 자바 코드 컨벤션을 지키면서 프로그래밍 한다.
- ident(들여쓰기) depth를 3이 넘지 않도록 구현한다. 2까지만 허용한다.
    - 예를 들어 while문안에 if문이 있으면 들여쓰기는 2이다.
    - 힌드: 인덴트 depth를 줄이는 좋은 방법은 함수를 분리하면 된다.
    - 함수가 한가지 일만 하도록 최대한 작게 만들어라
- space도 컨벤션이다
    - for while if 문 사이의 space도 컨벤션이다
- 불필요하게 공백 라인을 만들지 않는다
    - 공백 라인을 뛰으는것도 코드상에 문맥이 달라지는 부분에 의도를 가지고 띄우면 좋겠다.
- 깃 커밋 메시지를 의미있게 작성한다.
    - 커밋 메시지에 해당 커밋에서 작업한 내용에 대한 이해가 가능하도록 작성한다.
- 함수의 길이가 15라인을 넘어가지 않도록 구현한다
    - 함수가 한가지일만 잘하도록 구현한다
- else 예약어를 쓰지 않는다.
    - 힌트 if 조건절에서 값을 return 하는 방식으로 구현하면 else를 사용하지 않아도 된다.
    - else를 쓰지 말라고 하니 switch/case로 구현하는 경우가 있는데 switch/case도 허용하지 안흔다.
    - 자바 코드 컨벤션을 지키면서 프로그래밍 한다.
    - 들여쓰기 뎁스를 3이 넘지 않도록 구현한다.
    
- java api를 적ㅈ극적으로 활용한다
메소드를 직접 구현하기 전에 java api에서 제공하는 기능인지 검색을 해본다
우승자 "pobi"와 "jason"2명이상일때 pobi jason으로 출력

```java
private void concat(){
    List<String> winners = Arrays.asList("pobi", "jason");
    String result = String.join(",", winners);

}
```    


- 함수(또는 메소드)의 길이가 10라인을 넘어가지 않도록 구현한다
    - 함수가 한가지 일만 잘하도록 구현한다.
- 들여쓰기가 2가 넘지 않도록 구현한다. 1까지만 허용한다.
    - 최대한 1을 유지하기 위해 노력하고 정말 힘든 경우 2까지 허용한다.
    - 예를들어 while문 안에 if문이 있으면 들여쓰기는 2이다
- 함수(메소드)의 인자수를 3개까지만 허용한다. 4개 이상은 허용하지 않는다.

객체에 메시지를 보내라
상태 데이터를 가지는 객체에서 데이터를 꺼내려(get) 하지 말고 객체에 메시지를 보내라
```java
private boolean isMaxPosition(Car car){
    return car.getPosition() == maxDistance;
}
```
```java
private boolean isMaxPosition(Car car){
    return car.isMaxPosition(maxDistance);
}
```


##### 요구사항

- 입력
    - 예약할 영화의 id번호
    - 예약할 시간표 번호
    - 예약할 인원수
    - 예약을 끝내고 최종 결제를 할것인지 추가예약을 받을지 결정
    - 결제 금액 입력 받기
    - 신용카드 현금 입력받기
- 중간과정
    - 맨처음 예매할 수 있는 영화가 있는지 부터 살펴본다
    - 영화의 id를 가지고 영화의 예약표를 찾는다
        - 상영 목록에 없으면 예외를 출력한다
    - 예약한 시간표를 예약한다
        - 단 1시간 이내 차이가 나면 예약받지 않고 사유를 출력한다.(예외)
        - 상영시간이 이미 지난 영화를 출력하면 예외를 처리한다.
    - 예약한 인원수를 바탕으로 예약 처리를 한다
        - 단 예매가는 인원을 초과하면 예매 불가하다고 한다.
        - 처음 스케줄 선택화면으로 돌아간다 왜냐하면 원하는 스케줄에 원하는 인원만큼 선택할 수 없기 때문이다.
    - 결제
        - 결제할때 신용카드는 5퍼센트 현금은 2퍼센트
        - 포인트를 사용할 수 있다.
            - 포인트에는 할인율 적용X 따로 구현
            - 포인트가 결제금액보다 많을시 0원을 부과한다
    - 최종 예매를 출력한다
    - 예외처리는 모두 구현했으나 그에 맞는 출력 메시지 기능을 구현하지 못한다.        

##### 요구사항

#### 기능구현 목록

- `예약` 예매가 가능한 목록을 출력해주고 예매할 영화를 입력해주는 기능
    - `예외처리` 상영목록에 없는 영화를 선택한 경우
    - `예외처리` 숫자가 아닌 수를 입력한경우
- `예약` 예약할 시간표를 묻는 기능 경우
    - `예외처리` 선택한 영화과 기존에 예매한 영화와 시간들과 1시간 이내가 아닌 경우
    - `예외처리` 상영 시작 시간이 이미 지난영화를 선택할 때
    - `예외처리` 스케쥴에 없는 번호를 입력하였을때
- `예약`
    - `예외처리`
    - `예외처리`

- 기능 구현 목록
- 커밋 로그
- 구현 코드


#### TDD, 리팩토링 적용 - 개인

- TDD, 리팩토링 == 운동
- 평생동안 연습하겠다는 마음가짐으로 시작


- 시작하기
    - 주변 정리해 꾸준히 연습할 시간 확보
    - 장난감 프로젝트 찾기
        - 회사 프로젝트에는 적용하지 말것!


- 단위테스트 연습
    - 내가 사용하는 API사용법을 익히기 위한 학습 테스트에서 시작
        - 자바String 클래스의 다양한 메소드(함수) 사용법
        - 자바 ArrayList에 데이터를 추가, 수정, 삭제하는 방법
        
```java
class AppTest {
    @Test
    public void split(){
        String[] values = "1".split(",");
        assertThat(values).contains("1");
        values = "1,2".split(",");
        assertThat(values).containsExactly("1" , "2");
    }

    @Test
    public void subString(){
        String input = "(1,2)";
        String result = input.substring(1 , input.length() -1);
        assertThat(result).isEqualTo("1,2");
    }

    @Test
    public void arrayList(){
        ArrayList<String> values = new ArrayList<>();
        values.add("first");
        values.add("second");
        assertThat(values.add("third")).isTrue();
        assertThat(values.size()).isEqualTo(3);
        
    }

}
```

연습효과
- 단위 테스트 방법을 학습할 수 있다.
- 단위테스트 도구의 사용법을 익힐수 있다.
- 사용하는 API에 대한 학습효과가 있다.


내가 구현하는 메소드중 Input과 Output이 명확한 클래스 메소드(Util 성격의 메소드) 에 대한 단위테스트 연습

알고리즘을 학습한다면 알고리즘 구현에 대한 검증을 단위테스트로 한다
알고리즘은 input, output이명확하기 때문에

- TDD 연습

어려운 문제를 해결하는 것이 목적이 아니라 TDD연습이 목적
난이도가 낮거나 자신에게 익숙한 문제로 시작하는것을 추천

꼭 요구사항이 복잡한게 아니다
작은 코드도 충분히 연습할수있다.

웹, 모바일 UI나 DB에 의존관계를 가지지 않는 요구사항으로 연습한다.

문자열 덧셈 계산기 요구사항
- 쉼표(,) 또는 콜론(:)을 구분자로 가지는 문자열을 전달하는 경우 구분자를 기준으로 분리한 각 숫자의 합을 반환

입력 출력
null 또는 "" 0
"1"         1
"1,2"       3
"1,2:3"     6

- TDD Circle of life
- Test Fails -> Test Passes -> Refactor -> Test Fails

#### 메소드 분리

테스트 코드는 변경하지 말고
테스트 대상 코드(프로덕션 코드)를 개선하는 연습을 집중한다.

메소드의 의도가 잘 드러나도록 동등한 수준의 작업을 하는 여러 단계로 나눈다.

한번에 모든 원칙을 지키면서 리팩토링하려고 연습하지 마라
한번에 한 가지 명확하고 구체적인 목표를 가지고 연습하라
연습은 극단적인 방법으로 연습하는 것도 좋다.
예를들어 한 메소드의 라인수를 제한 15라인 -> 10라인으로 줄여가면서 연습하는것도 좋다.

#### 리팩토링 연습 - 클래스 분리

쉼표, 또는 콜론: 을 구분자로 가지는 문자열을 전달하는 경우 구분자를 기준으로 분리한 각 숫자의 합을 반환
숫자 이외의 값 또는 음수를 전달하는 경우 RuntimeException 예외를 throw 한다.

- 클래스 분리 연습을 위해 활용할 수 있는 원칙
    - 일급 콜렉션을 쓴다.
    - 3개 이상의 인스턴스 변수를 가진 클래스를 쓰지 않는다.

#### 장난감 프로젝트 난이도 높이기

- 점진적으로 요구사항이 복잡한 프로그램을 구현한다.
- 앞에서 지켰던 기준을 지키면서 프로그래밍 연습을 한다.

리팩토링 연습하기 좋은 프로그램 요구사항
- 게임과 같이 요구사항이 명확한 프로그램으로 연습
- 의존관계가 없이 연습
- 약간은 복잡한 로직이 있는 프로그램

- 로또
- 사다리타기
- 볼링게임 점수판
- 체스게임
- 지뢰찾기 게임


#### 의존관계 추가를 통한 난이도 높이기

웹 모바일 데이터베이스 의존관계 추가

이때 필요한 역량은
- 테스트하기 쉬운 코드와 테스트하기 어려운 코드를 보는눈
- 테스트 하기 어려운 코드를 테스트 하기 쉬운 코드로 설계하는 감(sense)

- 앞단계 연습을 잘 소화했다면 테스트하기 쉬운 코드와 어려운 코드를 분리하는 역량이 쌓였을 것이다.


#### 한단계 더 나아간 연습을 하고싶다면
- 컴파일 에러를 최소화하면서 리팩토링하기
- ATDD기반으로 응용 애플리케이션 개발하기
- 레거시 애플리케이션에 테스트 코드를 추가해 리팩토링하기

- TDDD 리팩토링 적용이 실패하는 이유
    - TDD 리팩토링 연습이 충분하지 않은 상태에서
    레거시 애플리케이션에 테스트 코드 추가해 리팩토링하기와 같은 높은 난이도에 바로 도전
    
구체적인 연습 목표찾기

- 규칙1 : 한 메서드에 오직 한 단계의 들여쓰기만 한다.
- 규칙2 : else 예약어를 쓰지 않는다.
- 규칙3 : 모든 원시값과 문자열을 포장한다
- 규칙4 : 한줄에 점을 하나만 찍는다
- 규칙5 : 줄여쓰지 않는다
- 규칙6 : 모든 엔티티를 작게 유지한다
- 규칙7 : 3개이상의 인스턴스 변수를 가진 클래스를 쓰지 않는다.
- 규칙8 : 일급 콜렉션을 쓴다.
- 규칙9 : 게터 세터 프로퍼티를 쓰지 않는다.


메소드 인자개수
메소드에서 이상적인 인자 개수는 0개이다.
다음은 1개, 다음은 2개 3개는 피하고 4개는 쓰면 안된다

조급함 대신 마음의 여유
나만의 장난감 프로젝트
같은 과제를 반복적으로 구현할 수 있는 인내력, 꾸준함, 성실함



#### TDD, 리팩토링 적용 - 개인(주니어) -> 팀

- TDD 리팩토링의 필요성을 느꼈다.
- 너무좋다 팀에 전파하고싶다.

생각해볼점
- 사람은 기본적으로 변화를 거부하는 성향
- 팀은 변화를 거부하는 성향이 더 강함
- 대부분 사람들은 변화에 실패한 경험을 가지고 있다.

- 관심 있는 사람이 생기면 전파한다.

내가 구현한 코드 또는 동료의 관심에서 작은 성공을 맛본다.
리더가 하지 말라고 하면 그만둔다.

하지만 나는 많이 성장했기 때문에 갈 곳은 많다.
걱정하지 마라 절대 손해 보는 장사가 아니다.

연봉을 올려 이직한다.
TDD 리팩토링을 전파를 시도한다.
경력이 쌓이면서 내가 리더가 된다.

#### TDD, 리팩토링 적용 - 내가 리더

팀에 변화 만들기가 더 적합

생각해 볼점
- 사람은 기본적으로 변화를 거부하는 성향
- 팀은 변화를 거부하는 성향이 더 강함
- 대부분의 사람들은 변화를 실패한 경험이 있음

- 1:1로 공략
- 팀원이 개선할 부분을 말하고, 해결책을 제안하도록 유도

시작하기
- 팀원들과 신뢰 형성이 우선
- 1:1 면담을 통해 개선할 부분 찾기

1:1 면담에서 한 가지만 기억하자

- 팀원이 문제점을 이야기 할때
- 문제점에 대한 해답을 제시하려 하지말고
- "어떻게하면 될까?" "너라면 어떻게 할것 같아?" 라는 반문을 해라

